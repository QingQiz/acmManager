@using acmManager.Web.Controllers
@using acmManager.Authorization.Users
@inject UserController UserController
@model acmManager.Web.Models.Users.UserProfileViewModel
@section styles
{
    <environment name="Development">
        <link href="~/view-resources/Views/Users/Profile.css" rel="stylesheet"/>
        <link href="~/css/cropper.min.css" rel="stylesheet">
    </environment>
}
@section scripts
{
    <environment name="Development">
        <script type="text/javascript" src="~/js/cropper.min.js"></script>
        <script src="~/view-resources/Views/Users/Profile.js" type="application/javascript"></script>
        <script type="application/javascript">
            updateProfileEvent();
            selectFileEvent();
            InitCropper();
            clickUserPhotoEvent();
            changePasswordEvent();
            changeUserTypeEvent();
            updateFromAoxiangEvent();
        </script>
    </environment>
}
<div class="content-container" style="max-width: 1300px">
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-4 pb-5 userCard">
                <!-- Account Sidebar-->
                <div class="author-card pb-3">
                    <div class="author-card-cover"></div>
                    <div class="author-card-profile">
                        <div class="author-card-avatar">
                            <button class="btn btn-default" type="button" data-toggle="modal" data-target="#EditUserPhoto">
                                <img src="@(Model.Photo?.FilePath ?? UserController.DefaultUserPhoto)" alt="UserPhoto">
                            </button>
                        </div>
                        <div class="author-card-details">
                            <h5 class="author-card-name text-lg">@(Model.Name ?? "null")</h5><span class="author-card-position">Joined @(Model.CreationTime)</span>
                        </div>
                    </div>
                </div>
                <div class="wizard">
                    <nav class="list-group list-group-flush">
                        <a class="list-group-item active" href="#profile-setting" data-toggle="pill">
                            <img src="~/img/profile.svg" alt=""> 个人资料
                        </a>
                        <a class="list-group-item" href="#profile-settings" data-toggle="pill">
                            <img src="~/img/settings.svg" alt=""> 账户设置
                        </a>
                        <a class="list-group-item" href="#profile-change-password" data-toggle="pill">
                            <img src="~/img/edit.svg" alt=""> 更改密码
                        </a>
                    </nav>
                </div>
            </div>
            <div class="col-lg-8 pb-5 tab-content">
                <!-- Profile Settings-->
                <div class="tab-pane fade show active" id="profile-setting">
                    <form class="row" id="ProfileForm" method="post" asp-action="UpdateUserProfile">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-name">姓名</label>
                                <input class="form-control" type="text" disabled id="account-name" value="@(Model.Name ?? "null")">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-gender">性别</label>
                                <input class="form-control" type="text" id="account-gender" value="@(Model.Gender == UserGender.Male ? "男" : "女")" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-sn">学号</label>
                                <input class="form-control" type="text" disabled id="account-sn" value="@(Model.StudentNumber ?? "null")">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-cn">班号</label>
                                <input class="form-control" type="text" disabled id="account-cn" value="@(Model.ClassId ?? "null")">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-org">学院</label>
                                <input class="form-control" type="text" id="account-org" value="@(Model.Org ?? "null")" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-major">专业</label>
                                <input class="form-control" type="text" id="account-major" value="@(Model.Major ?? "null")" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-email">邮箱</label>
                                <input class="form-control" name="Email" type="email" id="account-email" value="@(Model.Email ?? "null")">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-phone">电话</label>
                                <input class="form-control" name="Mobile" type="text" id="account-phone" value="@(Model.Mobile ?? "null")">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-location">校区</label>
                                <input class="form-control" type="text" id="account-location" value="@(Model.Location ?? "null")" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-st-type">学生类型</label>
                                <input class="form-control" type="text" id="account-st-type" value="@(Model.StudentType ?? "null")" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-type">账号类型</label>
                                <input class="form-control" type="text" id="account-type" value="@(UserController.UserTypeToString(Model.Type))" disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="account-id">ID</label>
                                <input class="form-control" type="text" id="account-id" value="@(Model.UserId)" disabled>
                            </div>
                        </div>
                        <div class="col-12">
                            <hr class="mt-2 mb-3">
                            <div class="d-flex flex-wrap justify-content-between align-items-center">
                                <div class="d-block">
                                    <div class="alert alert-danger" style="display: none">

                                    </div>
                                </div>
                                <button class="btn btn-style-1 btn-primary" type="button" id="UpdateProfile">Upadte Profile</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="tab-pane fade" id="profile-settings">
                    @if (Model.Type == UserType.TeamLeader || Model.Type == UserType.Member)
                    {
                        <div class="alert alert-danger">
                            @if (Model.Type == UserType.Member)
                            {
                                <h4 class="alert-heading">
                                    我要退役
                                </h4>
                                <p>
                                    此操作会使你的用户类型从 <strong> 正式队员 </strong> 变为 <strong> 退役队员 </strong>，且不可恢复
                                </p>
                            }
                            else
                            {
                                <h4 class="alert-heading">
                                    我要辞职
                                </h4>
                                <p>
                                    此操作会使你的用户类型从 <strong> 队长 </strong> 变为 <strong> 正式成员 </strong>，且不可恢复
                                </p>
                            }
                            <hr>
                            <div style="text-align: right">
                                <button class="btn btn-danger" id="submit-usertype-changes" data-toggle="modal" data-target="#are-you-sure"> 确认 </button>
                            </div>
                            <div class="modal fade" id="are-you-sure">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            你确定吗
                                        </div>
                                        <div class="modal-body">
                                            此操作不可逆 ！！
                                        </div>
                                        <form asp-action="Relegate" method="post" id="change-usertype-form">
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal" id="usertype-changes-dismiss">取消</button>
                                                <button type="button" class="btn btn-danger btn-ok" id="usertype-changes-apply">确认</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    @if (Model.StudentNumber != null && Model.StudentNumber.Length == 10)
                    {
                        <div class="alert alert-info">
                            <h4 class="alert-heading">
                                更新你的个人信息
                            </h4>
                            <p>
                                此操作会从翱翔门户拉取你的学生信息。因此需要你提供翱翔门户的密码。
                            </p>
                            <hr>
                            <div style="text-align: right">
                                <button class="btn btn-info" data-toggle="modal" data-target="#input-aoxiang-password">
                                    确认
                                </button>
                            </div>
                        </div>
                        <div class="modal fade" id="input-aoxiang-password">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        输入你的翱翔门户密码
                                    </div>
                                    <div class="modal-body">
                                        <form asp-action="UpdateFromAoxiang" method="post" id="update-from-aoxiang-form">
                                            <input style="display: none" type="password" name="fake-password-remembered" />
                                            <div class="form-group">
                                                <label for="update-from-aoxiang-password">Password</label>
                                                <input class="form-control" type="password" name="Password" id="update-from-aoxiang-password" placeholder="Password">
                                            </div>
                                            <div class="form-group">
                                                <label for="update-from-aoxiang-password-again">Password Again</label>
                                                <input class="form-control" type="password" name="PasswordAgain" id="update-from-aoxiang-password-again" placeholder="Password Again">
                                            </div>
                                            <div class="alert alert-danger" style="display: none" id="update-from-aoxiang-alert"></div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal" id="update-from-aoxiang-cancel">取消</button>
                                                <button type="button" class="btn btn-danger btn-ok" id="update-from-aoxiang-submit">确认</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Change Password-->
                <div class="tab-pane fade" id="profile-change-password">
                    <form method="post" asp-action="ChangeUserPassword" id="ChangePasswordForm">
                        <div class="form-group">
                            <label for="change-password-current">Current Password</label>
                            <input class="form-control" type="password" name="CurrentPassword" id="change-password-current" placeholder="Current">
                        </div>
                        <div class="form-group">
                            <label for="change-password-new">New Password</label>
                            <input class="form-control" type="password" name="NewPassword" id="change-password-new" placeholder="New Password">
                        </div>
                        <div class="form-group">
                            <label for="change-password-new">New Password Again</label>
                            <input class="form-control" type="password" name="NewPasswordAgain" id="change-password-new-again" placeholder="New Password">
                        </div>
                        <hr/>
                        <div class="row">
                            <div class="col-10">
                                <div class="alert alert-danger" style="display: none" id="change-password-error">
                                </div>
                                <div class="alert alert-success" style="display: none" id="change-password-success">
                                    Success
                                </div>
                            </div>
                            <div class="col-2" style="text-align: right">
                                <button class="btn btn-style-1 btn-primary" type="button" id="ChangePasswordBtn">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- User Photo -->
<div class="modal fade" id="EditUserPhoto" tabindex="-1" role="dialog" aria-labelledby="EditUserPhoto" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修改头像</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" asp-action="EditUserPhoto" enctype="multipart/form-data" id="UpdatePhotoForm">
                    <div class="container">
                        <input type="file" class="custom-file-input" id="CropperFile" name="OriginalPhoto"/>
                        <label for="CropperFile" class="custom-file-label">Choose an image</label>
                        <br/> <br/>
                        <div>
                            <img src="" id="cropper-img" alt=""/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="UpdatePhotoBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>